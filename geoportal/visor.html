<!DOCTYPE>
<html>
<head>
<meta charset="utf-8">
<link rel='stylesheet' href='https://bootswatch.com/united/bootstrap.min.css'></link>
<link rel='stylesheet' href='/stylesheets/style.css'></link>

<link rel="stylesheet" href="/ol3/ol.css" type="text/css"></link>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.12/proj4.js"></script>
<script src="/ol3/ol.js"></script>
<link rel="stylesheet" href="/ol3-layerswitcher/src/ol3-layerswitcher.css"></link>
<script src="/ol3-layerswitcher/src/ol3-layerswitcher.js"></script>

<script type="text/javascript" src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js'></script>
<link rel="stylesheet" href="http://openlayers.org/en/v3.11.0/examples/popup.css">
<style>
.ol-popup {
  position: absolute;
  background-color: white;
  -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
  filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #cccccc;
  bottom: 12px;
  left: -50px;
  width: 50%;
}
.ol-popup:after, .ol-popup:before {
  top: 100%;
  border: solid transparent;
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  pointer-events: none;
}
.ol-popup:after {
  border-top-color: white;
  border-width: 10px;
  left: 48px;
  margin-left: -10px;
}
.ol-popup:before {
  border-top-color: #cccccc;
  border-width: 11px;
  left: 48px;
  margin-left: -11px;
}
.ol-popup-closer {
  text-decoration: none;
  position: absolute;
  top: 2px;
  right: 8px;
}
.ol-popup-closer:after {
  content: "✖";
}

</style>

<script type="text/javascript">

$(function(){
	
	$('#menu').addClass('goToTop');
	$('.navbar-brand, .navbar-nav > li >  a').addClass('goToTop2');
	$('.top-shadow').css({'display':'block'});
	
	// MAPA
	var resolutions = new Array(22);
	var matrixIds = new Array(22);
	var resInicial = 0.703125;
	
	for (var i=0; i < 22; i++){
		matrixIds[i] = "EPSG:4326:" + i;
		resolutions[i] = resInicial/Math.pow(2,i);
	}
	
	// EPSG: 4258 ETRS89 --> http://epsg.io
	proj4.defs("EPSG:4258","+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs");
	//Obtenemos la proyección definida
	var proj = ol.proj.get('EPSG:4258');
	// formato de imagen de las peticiones al servidor WMS
    var format = 'image/png';
    // Cogemos una extensión que incluya un poco más que nuestro municipio
    var bounds = [-0.65, 39.35,
                  -0.40, 39.46];
    // Le damos una extensión a la proyección
    // Esto es requerido para calcular el nivel de zoom 0
    // El zoom 0 se adaptaría a la extensión de nuestro municipio
	proj.setExtent(bounds);
    // MousePosition Control --> ol.control.MousePosition
	var mousePositionControl = new ol.control.MousePosition({
        coordinateFormat: ol.coordinate.toStringHDMS,
    });
	
    // GET FEATURE INFO
    var popup = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
	  element: document.getElementById('popup'),
	  autoPan: true,
	  autoPanAnimation: {
	    duration: 250
	  }
	}));
    
	// Mapa --> ol.Map
    var map = new ol.Map({
    	controls: ol.control.defaults({ 
    		attribution: false // No atribución
    	}).extend([mousePositionControl, // MousePosition
    	           new ol.control.FullScreen(), // FullScreen
    	           new ol.control.LayerSwitcher({tipLabel: 'Leyenda'}), // LayerSwitcher
    	           new ol.control.ScaleLine(), // ScaleLine
    	           new ol.control.ZoomSlider() // ZoomSlider
    	]),
    	target: 'map',
    	overlays : [popup],
    	view: new ol.View({
    		projection: proj,
    		zoom: 3,
    		center: ol.proj.fromLonLat([-0.47343, 39.42811], 'EPSG:4258'),
    		minZoom: 0,
    		maxZoom: 10
    		// Importante poner nuestra proyección, aunque es un parámetro opcional HAY QUE PONERLO!
    	})
    });
	
    // Capa vacía --> Cuando no queremos que haya mapa base
    var layerVectorVacia = new ol.layer.Vector({
    	title:'Vacía',
    	type: 'base'
    });
    
    /*
     *  Capa de nuestro servidor WMS
     */
    
    // Ortofoto
    // Denuncias
    var orto = new ol.layer.Tile({
    	title: 'Ortofoto',
    	visible: false,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:ortofoto',
                 	 STYLES: '',
    		}
    	})
    });
    
    //Municipio
    var municipio = new ol.layer.Tile({
    	title: 'Municipio',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:muni_torrent',
                 	 STYLES: '',
    		}
    	})
    });
    
    // Manzanas
    var manzanas = new ol.layer.Tile({
    	title: 'Manzanas',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:manzanas',
                 	 STYLES: '',
    		}
    	})
    });
    
    // Viales
    var viales = new ol.layer.Tile({
    	title: 'Viales',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:viales',
                 	 STYLES: '',
    		}
    	})
    });
    
    // Caminos
    var caminos = new ol.layer.Tile({
    	title: 'Caminos',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:caminos',
                 	 STYLES: '',
    		}
    	})
    });
    
    // Etiquetas Viales
    var nom_viales = new ol.layer.Tile({
    	title: 'Etiquetado Calles',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:nombres_viales',
                 	 STYLES: '',
    		}
    	})
    });
    
    
    // Portales
    var portales = new ol.layer.Tile({
    	title: 'Portales',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:portales',
                 	 STYLES: '',
    		}
    	})
    });
    
    
    // Denuncias
    var denuncias = new ol.layer.Tile({
    	title: 'Denuncias',
    	visible: true,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.0',
                 	 tiled: true,
                 	 LAYERS: 'jahr:denuncias',
                 	 STYLES: '',
    		}
    	})
    });
    
    /*
     *  Capa de nuestro servidor WMS Teselado (GeoWebCache)
     */
    
    // Ortofoto
    var ortoWMST = new ol.layer.Tile({
    	title: 'Ortofoto',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:ortofoto',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	})
    });
    
    //Municipio
    var municipioWMST = new ol.layer.Tile({
    	title: 'Municipio',
    	visible: false,
    	source: new ol.source.TileWMS({
    		url: 'http://localhost:8080/geoserver/jahr/wms',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.1',
                 	 tiled: true,
                 	 LAYERS: 'jahr:muni_torrent',
                 	 STYLES: '',
    		},
    		gutter: 200
    	})
    });
    
    // Manzanas
    var manzanasWMST = new ol.layer.Tile({
    	title: 'Manzanas',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:manzanas',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	}),
    });
    
    // Viales
    var vialesWMST = new ol.layer.Tile({
    	title: 'Viales',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:viales',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	}),
    });
    
    // Caminos
    var caminosWMST = new ol.layer.Tile({
    	title: 'Caminos',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:caminos',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	}),
    });
    
    // Etiquetas Viales
    var nom_vialesWMST = new ol.layer.Tile({
    	title: 'Etiquetado Calles',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:nombres_viales',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	}),
    });
    
    // Portales
    var portalesWMST = new ol.layer.Tile({
    	title: 'Portales',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:portales',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	}),
    });
    
    // Denuncias
    var denunciasWMST = new ol.layer.Tile({
    	title: 'Denuncias',
    	visible: false,
    	source: new ol.source.WMTS({
    		url: 'http://localhost:8080/geoserver/gwc/service/wmts',
    		layer:'jahr:denuncias',
    		matrixSet: 'EPSG:4326',
    		format: 'image/png',
    		projection: proj,
    		tileGrid: new ol.tilegrid.WMTS({
    			origin : [-180, 90],
    			resolutions : resolutions,
    			matrixIds : matrixIds
    		})
    	}),
    });
    
    
    
    
    /*
     * Capas de otros servidores WMS
     */
    
    //Mapa base del IGN
    var ignBase = new ol.layer.Tile({
    	title: 'IGN Base',
    	visible: false,
    	source: new ol.source.TileWMS({
    		url: 'http://www.ign.es/wms-inspire/ign-base',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.1',
                 	 tiled: true,
                 	 LAYERS: 'IGNBaseTodo',
                 	 STYLES: '',
    		}
    	})
    });
    
    //Ortofoto PNOA
    var ortoPNOA = new ol.layer.Tile({
    	title: 'Ortofoto PNOA',
    	visible: false,
    	source: new ol.source.TileWMS({
    		url: 'http://www.ign.es/wms-inspire/pnoa-ma',
    		params: {'FORMAT': format, 
                 	 'VERSION': '1.1.1',
                 	 tiled: true,
                 	 LAYERS: 'OI.OrthoimageCoverage',
                 	 STYLES: '',
    		}
    	})
    });
    
    // Grupo de Capas 1.--> Mapas base
    // Capa vacía, mapa base ign, ortofoto PNOA
    var groupCapasBase = new ol.layer.Group({
    	title: 'Capas Base',
    	layers: [layerVectorVacia, ignBase, ortoPNOA]
    });
    
    // Grupo de Capas 2.--> Cartografía de nuestro servidor WMS
    // orto, municipio, manzanas, viales, caminos, nom_viales, portales
    var groupCartoTorrentWMS = new ol.layer.Group({
    	title: 'Cartografía de Torrent WMS',
    	layers: [orto, municipio, manzanas, viales, caminos, nom_viales, portales, denuncias]
    });
    var groupCartoTorrentWMST = new ol.layer.Group({
    	title: 'Cartografía de Torrent WMS Teselado',
    	layers: [ortoWMST, municipioWMST, manzanasWMST, vialesWMST, 
    	         caminosWMST, nom_vialesWMST, portalesWMST, denunciasWMST]
    });    
    map.addLayer(groupCapasBase); // Añadimos grupo de Capas 1
    map.addLayer(groupCartoTorrentWMST); // Añadimos grupo de Capas 2
    map.addLayer(groupCartoTorrentWMS); // Añadimos grupo de Capas 2

    
    // Añadimos Control OverviewMap
    map.addControl(new ol.control.OverviewMap({
 	   layers: [new ol.layer.Tile(ignBase.getProperties())], 
 	   view: new ol.View({ // Importante añadir la View con nuestra proyección
 		   projection: proj  
 	   })
    }));
    
    // GET FEATURE INFO
    var div = $('<div>');
    var hayInfo = false;
    map.on('singleclick', function(evt){
    	
    	$('#popup-content').empty();
    	div = $('<div>');
    	
    	var coordinate = evt.coordinate;
    	
    	div.append('<p>' + ol.coordinate.toStringHDMS(coordinate) + '</p>');
    	
    	groupCartoTorrentWMS.getLayers().forEach(function(layer){
    		console.log(layer);
    		var url;
    		var append = '';
    		if(layer.getSource() instanceof ol.source.TileWMS && layer.getVisible())
    		{
    			url = layer.getSource().getGetFeatureInfoUrl(coordinate, 
    									map.getView().getResolution(), 
    									proj, {'INFO_FORMAT': 'text/html'});
    			$.get(url, function(data){ 
    				  hayInfo = true;
    	    		  $(div).append(data);
    			});
    		}

    	});
    	if (hayInfo){
        	$('#popup-content').append(div);
        	popup.setPosition(coordinate);
        	hayInfo = false;
    	}

    });
    
    $('#popup-closer').click(function() {
    	  popup.setPosition(undefined);
    	  $(this).blur();
    	  return false;
    });
    
	// FIN MAPA
	
});

</script>
</head>
<body style="margin:0px;">
<nav id="menu" style="width:100%;margin:0 auto;border-radius:0 0 0 0;z-index:10000;border:0px" role="navigation" class="navbar navbar-default">
  <div style="padding-right:0px" class="container-fluid">
    <div class="navbar-header">
      <button type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false" class="navbar-toggle collapsed"><span class="sr-only"></span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" style="display:flex" class="navbar-brand">Geoportal de Torrent</a>
    </div>
    <div id="bs-example-navbar-collapse-1" style="padding-right:0px" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown"><a href="/servicios" class="centrado">Servicios</a>
        <ul class="dropdown-menu">
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/jahr/wms?REQUEST=GetCapabilities&version=1.3.0">WMS</a>
        	</li>
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/jahr/wms?REQUEST=GetCapabilities&version=1.3.0&service=wfs">WFS</a>
        	</li>
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/jahr/wms?REQUEST=GetCapabilities&version=1.3.0&service=WCS">WCS</a>
        	</li>
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/gwc/service/wmts?request=GetCapabilities&service=WMTS&version=1.3.0">WMS Teselado</a>
        	</li>
       	</ul>
        </li>
        <li><a href="/visor" class="centrado">Visor de Cartografía</a></li>
        <li><a href="/descargas" class="centrado">Descarga de Cartografía</a></li>
      </ul>
      <ul style="margin-right:0px" class="nav navbar-nav navbar-right">
      </ul>
    </div>
  </div>
</nav>
<div style="width: 100%; height:90%;margin-top:80px;">
<div class="container-fluid" style="padding: 0px !important;">

<div class="row-fluid">
  <div class="span12">
    <div id="map" class="map" style="width: 100%; height:100%;"></div>
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content" style="overflow-x:scroll"></div>
    </div>
  </div>
</div>

</div>
</div>
</body>
</html>