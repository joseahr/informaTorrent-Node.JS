<!DOCTYPE>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel='stylesheet' href='https://bootswatch.com/united/bootstrap.min.css'></link>

<link rel="stylesheet" href="/javascripts/openlayers/ol3/ol.css" type="text/css"></link>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.12/proj4.js"></script>
<script src="/javascripts/openlayers/ol3/ol.js"></script>
<link rel="stylesheet" href="/javascripts/openlayers/ol3-layerswitcher/src/ol3-layerswitcher.css"></link>
<script src="/javascripts/openlayers/ol3-layerswitcher/src/ol3-layerswitcher.js"></script>

<script src="/javascripts/openlayers/style.js"></script>
<script src="/javascripts/openlayers/proj.js"></script>
<script src="/javascripts/openlayers/capas.js"></script>

<script type="text/javascript" src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js'></script>
<link rel="stylesheet" href="http://openlayers.org/en/v3.11.0/examples/popup.css">
<link rel='stylesheet' href='/stylesheets/style.css'></link>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">


<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<style>
.ol-popup {
  position: absolute;
  background-color: white;
  -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
  filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #cccccc;
  bottom: 12px;
  left: -50px;
  width: 50% !important;
}
.ol-popup:after, .ol-popup:before {
  top: 100%;
  border: solid transparent;
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  pointer-events: none;
}
.ol-popup:after {
  border-top-color: white;
  border-width: 10px;
  left: 48px;
  margin-left: -10px;
}
.ol-popup:before {
  border-top-color: #cccccc;
  border-width: 11px;
  left: 48px;
  margin-left: -11px;
}
.ol-popup-closer {
  text-decoration: none;
  position: absolute;
  top: 0px;
  right: 8px;
  padding-bottom: 5px;
}
.ol-popup-closer:after {
  content: "✖";
}

</style>

<script type="text/javascript">

$(function(){
	var helpTooltipElement, helpMsg;
	
	function createHelpTooltip() {
	    if (helpTooltipElement) {
	      helpTooltipElement.parentNode.removeChild(helpTooltipElement);
	    }
	    helpTooltipElement = document.createElement('div');
	    helpTooltipElement.className = 'tooltip hidden';
	    helpTooltip = new ol.Overlay({
	      element: helpTooltipElement,
	      offset: [15, 0],
	      positioning: 'center-left'
	    });
	    map.addOverlay(helpTooltip);
	}
	
	var pointerMoveHandler = function(evt) {
		  if (evt.dragging || !info) {
		    return;
		  }
		  /** @type {string} */
		  var helpMsg = '<i class="fa fa-info-circle"></i> Click para obtener información';
		
		  helpTooltipElement.innerHTML = helpMsg;
		  helpTooltip.setPosition(evt.coordinate);
		
		  $(helpTooltipElement).removeClass('hidden');
		};
	
	$('#menu').addClass('goToTop');
	$('.navbar-brand, .navbar-nav > li >  a').addClass('goToTop2');
	$('.top-shadow').css({'display':'block'});
	
	var info = false;
    // MousePosition Control --> ol.control.MousePosition
	var mousePositionControl = new ol.control.MousePosition({
        coordinateFormat: ol.coordinate.toStringHDMS,
    });
	
    // GET FEATURE INFO
    var popup = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
	  element: document.getElementById('popup'),
	  autoPan: true,
	  autoPanAnimation: {
	    duration: 250
	  }
	}));
    
	// Mapa --> ol.Map
    var map = new ol.Map({
    	controls: ol.control.defaults({ 
    		attribution: false // No atribución
    	}).extend([mousePositionControl, // MousePosition
    	           new ol.control.FullScreen(), // FullScreen
    	           new ol.control.LayerSwitcher({tipLabel: 'Leyenda'}), // LayerSwitcher
    	           new ol.control.ScaleLine(), // ScaleLine
    	           new ol.control.ZoomSlider() // ZoomSlider
    	]),
    	target: 'map',
    	overlays : [popup],
    	view: new ol.View({
    		projection: proj,
    		zoom: 3,
    		center: ol.proj.fromLonLat([-0.47343, 39.42811], 'EPSG:4258'),
    		minZoom: 0,
    		maxZoom: 10
    		// Importante poner nuestra proyección, aunque es un parámetro opcional HAY QUE PONERLO!
    	})
    });
	
    map.addLayer(groupCapasBase); // Añadimos grupo de Capas 1
    map.addLayer(groupCartoTorrentWMST); // Añadimos grupo de Capas 2
    map.addLayer(groupCartoTorrentWMS); // Añadimos grupo de Capas 2

    
    // Añadimos Control OverviewMap
    map.addControl(new ol.control.OverviewMap({
 	   layers: [new ol.layer.Tile(ignBase.getProperties())], 
 	   view: new ol.View({ // Importante añadir la View con nuestra proyección
 		   projection: proj  
 	   })
    }));
    
    ignBase.setVisible(false);
    
    // GET FEATURE INFO
    var div = $('<div>');
    var hayInfo = false;
    map.on('singleclick', function(evt){
    	if (!info) {$('.ol-popup').addClass('hidden'); return;}
    	$('.ol-popup').removeClass('hidden');
    	$('#popup-content').empty();
    	div = $('<div>');
    	
    	var coordinate = evt.coordinate;
    	
    	div.append('<p>' + ol.coordinate.toStringHDMS(coordinate) + '</p>');
    	
    	groupCartoTorrentWMS.getLayers().forEach(function(layer){
    		console.log(layer);
    		var url;
    		var append = '';
    		if(layer.getSource() instanceof ol.source.TileWMS && layer.getVisible())
    		{
    			url = layer.getSource().getGetFeatureInfoUrl(coordinate, 
    									map.getView().getResolution(), 
    									proj, {'INFO_FORMAT': 'text/html'});
    			$.get(url, function(data){ 
    				  hayInfo = true;
    	    		  $(div).append(data);
    	    		  $('table.featureInfo').addClass('table table-responsive auto');
    	    		  $('table.featureInfo tbody tr th').addClass('info auto');
    			});
    			
    		}

    	});
    	if (hayInfo){
        	$('#popup-content').append(div);
        	popup.setPosition(coordinate);
        	hayInfo = false;
    	}

    });
    
    $('#popup-closer').click(function() {
    	  popup.setPosition(undefined);
    	  $(this).blur();
    	  return false;
    });
    
    map.on('pointermove', pointerMoveHandler);
    createHelpTooltip();
    
	// FIN MAPA
	
	$('[data-toggle="tab"]').popover({
	    trigger: 'hover',
	    'placement': 'top'
	});
	
	$('#mover').click(function(){
		$(helpTooltipElement).addClass('hidden');
		info = false;
	});
	$('#info').click(function(){
		$(helpTooltipElement).removeClass('hidden');
		info = true;
	});
	
});

</script>
</head>
<body style="margin:0px;">
<nav id="menu" style="width:100%;margin:0 auto;border-radius:0 0 0 0;z-index:10000;border:0px" role="navigation" class="navbar navbar-default">
  <div style="padding-right:0px" class="container-fluid">
    <div class="navbar-header">
      <button type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false" class="navbar-toggle collapsed"><span class="sr-only"></span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" style="display:flex" class="navbar-brand">Geoportal de Torrent</a>
    </div>
    <div id="bs-example-navbar-collapse-1" style="padding-right:0px" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown"><a href="/servicios" class="centrado">Servicios</a>
        <ul class="dropdown-menu">
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/jahr/wms?REQUEST=GetCapabilities&version=1.3.0">WMS</a>
        	</li>
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/jahr/wms?REQUEST=GetCapabilities&version=1.3.0&service=wfs">WFS</a>
        	</li>
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/jahr/wms?REQUEST=GetCapabilities&version=1.3.0&service=WCS">WCS</a>
        	</li>
        	<li>
        		<a target="_blank" href="http://localhost:8080/geoserver/gwc/service/wmts?request=GetCapabilities&service=WMTS&version=1.3.0">WMS Teselado</a>
        	</li>
       	</ul>
        </li>
        <li><a href="/visor" class="centrado">Visor de Cartografía</a></li>
        <li><a href="/descargas" class="centrado">Descarga de Cartografía</a></li>
      </ul>
      <ul style="margin-right:0px" class="nav navbar-nav navbar-right">
      </ul>
    </div>
  </div>
</nav>
<div style="width: 100%; height:90%;margin-top:70px;">
<div class="container-fluid" style="padding: 0px !important;">

<div class="row-fluid">
  <div class="span12">
    <div id="map" class="map" style="width: 100%; height:100%;">
    	<button id="mover" style="position:absolute; bottom: 10px; left: 20%; z-index: 10; width:15%;" class="btn btn-success" data-toggle="tab" data-content="Moverse en el mapa">
    		<i class="fa fa-hand-pointer-o"></i>
    	</button>
    	<button id="info" style="position:absolute; bottom: 10px; left: 36%; z-index: 10; width:15%;" class="btn btn-success" data-toggle="tab" data-content="Obtener Información">
			<i class="fa fa-info-circle"></i>
		</button>
    </div>
    <div id="popup" class="ol-popup" style="min-width: 400px;">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content" style="overflow:scroll; max-height: 400px; width: 370px;"></div>
    </div>
  </div>
</div>

</div>
</div>


</body>
</html>