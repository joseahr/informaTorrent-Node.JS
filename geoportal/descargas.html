<!DOCTYPE>
<html>
<head>
<meta charset="utf-8">

<!-- Para dispositivos móviles -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<!-- Font Awesome Iconos -->
<link rel="stylesheet" href="/stylesheets/font-awesome/css/font-awesome.css">

<!-- Fuentes -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700,300&amp;subset=latin,latin-ext' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Raleway:700,400,300' rel='stylesheet' type='text/css'>

<!-- CSS Principal -->
<link rel="stylesheet" href="/stylesheets/style.css">

<!-- CSS Animaciones -->
<link rel="stylesheet" href="/stylesheets/animations.css">

<!-- Highlight CSS -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/styles/default.min.css">

<!-- LayerSwitcher CSS -->
<link rel="stylesheet" href="/javascripts/plugins/ol3-layerswitcher/src/ol3-layerswitcher.css">

<!-- OpenLayers CSS -->
<link rel="stylesheet" href="/javascripts/plugins/ol3/ol.css" type="text/css">

<!-- CSS OpenLayers Popup -->
<link rel="stylesheet" href="http://openlayers.org/en/v3.11.0/examples/popup.css">

<!-- Bootstrap Select CSS -->
<link rel="stylesheet" href="/javascripts/plugins/bootstrap-select/dist/css/bootstrap-select.css">

<!-- Prefix free -->
<script src="https://raw.githubusercontent.com/LeaVerou/prefixfree/gh-pages/prefixfree.min.js"></script>

</head>

<body class="no-trans">
	
	<!-- header start -->
	<!-- ================ --> 
	<header class="header clearfix navbar navbar-fixed-top" style="margin-bottom: 0px !important;" data-animation-effect="fadeOutLeft">
		<div class="container">
			<div class="row">
				<div class="col-md-4">
	
					<!-- header-left start -->
					<!-- ================ -->
					<div class="header-left clearfix">
	
						<!-- logo -->
						<div class="logo smooth-scroll">
							<a href="#banner">
								<span class="fa-stack fa-lg">
								  <i class="fa fa-circle fa-stack-2x"></i>
								  <i class="fa fa-location-arrow fa-stack-1x fa-inverse"></i>
								</span>
							</a>
						</div> 
	
						<!-- name-and-slogan -->
						<div class="site-name-and-slogan smooth-scroll">
							<div class="site-name"><a href="/">Geoportal de Torrent</a></div>
							<div class="site-slogan">Tu portal de información Geográfica</div>
						</div>
	
					</div>
					<!-- header-left end -->
	
				</div>
				<div class="col-md-8">
	
					<!-- header-right start -->
					<!-- ================ -->
					<div class="header-right clearfix">
	
						<!-- main-navigation start -->
						<!-- ================ -->
						<div class="main-navigation animated">
	
							<!-- navbar start -->
							<!-- ================ -->
							<nav class="navbar navbar-default" role="navigation">
								<div class="container-fluid">
	
									<!-- Toggle get grouped for better mobile display -->
									<div class="navbar-header">
										<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
											<span class="sr-only">Abrir Menú</span>
											<span class="icon-bar"></span>
											<span class="icon-bar"></span>
											<span class="icon-bar"></span>
										</button>
									</div>
	
									<!-- Collect the nav links, forms, and other content for toggling -->
									<div class="collapse navbar-collapse scrollspy smooth-scroll" id="navbar-collapse-1">
										<ul class="nav navbar-nav navbar-right">
											<li class="active"><a href="/">Inicio</a></li>
											<li class=""><a href="/#servicios">Servicios</a></li>
											<li><a href="/visor">Visor</a></li>
											<li><a href="#descargas">Descargas</a></li>
											<li><a href="#buscador">Buscador</a></li>
										</ul>
									</div>
	
								</div>
							</nav>
							<!-- navbar end -->
	
						</div>
						<!-- main-navigation end -->
	
					</header>
					<!-- header-right end -->
	
				</div>
			</div>
		</div>
	</div>
	<!-- header end -->
	
	
	<!-- section start -->
	<!-- ================ -->
	<div id="map" class="clearfix object-non-visible" data-animation-effect="fadeInRightBig">
				
		<!-- Botón abrir cerrar menú página -->
		<!-- Botón Moverse por mapa -->
		<button id="show_menu" type="button" class="btn btn-small btn-info btn-map" style=" z-index: 2; position: absolute; right: 0.5em; bottom: 30%; min-width: 1.375em">
			<i class="fa fa-navicon"></i>
		</button>
				
		<!-- Botón Moverse por mapa -->
		<button id="mover" type="button" class="btn btn-small btn-info btn-map" style=" z-index: 2; position: absolute; right: 0.5em; bottom: 10%; min-width: 1.375em">
			<i class="fa fa-hand-o-up"></i>
		</button>
	
		<!-- Botón BBOX -->
		<button id="bbox" type="button" class="btn btn-small btn-info btn-map" style=" z-index: 2; position: absolute; right: 0.5em; bottom: 20%; min-width: 1.375em">
			<i class="fa fa-download"></i>
		</button>
		
		<!-- Selector Capas Descargar -->
		<div style="position: absolute; top: 0.5em; left: 20%; right: 20%; z-index: 2" class="btn-map">
			<select id="capas_mapa" class="selectpicker" data-style="btn-info" data-live-search="false" style="width: 100%">
		   		<option value="jahr:muni_torrent">Municipio</option>
	 			<option value="jahr:manzanas">Manzanas</option>
	 			<option value="jahr:viales">Viales</option>
	 			<option value="jahr:caminos">Caminos</option>
	 			<option value="jahr:portales">Portales</option>
	 			<option value="jahr:nombres_viales">Etiquetado Calles</option>
	 			<option value="jahr:denuncias">Denuncias</option>
		   	</select>
		</div>
	</div>
	<!-- section end -->
	

<!-- Plugins Javascript situados al final de la página, así el contenido carga antes -->

<!-- JQuery y Bootstrap -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<!-- Modernizr -->
<script type="text/javascript" src="/javascripts/plugins/modernizr.js"></script>

<!-- Jquery appear -->
<script type="text/javascript" src="/javascripts/plugins/jquery.appear.js"></script>

<!-- JS Principal -->
<script type="text/javascript" src="/javascripts/template.js"></script>

<!-- FitText.js  -->
<script type="text/javascript" src="/javascripts/plugins/jquery.fittext.js"></script>

<!-- Bootstrap Dialog JS (Nakupanda)  -->
<script type="text/javascript" src="/javascripts/plugins/bootstrap-dialog.js"></script>

<!-- Highlight JS -->
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/highlight.min.js"></script>

<!-- Abrir cerrar header efecto movil mapa-->
<script src="/javascripts/close_header_mobile_map.js"></script>

<!-- Proj4.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.12/proj4.js"></script>

<!-- OpenLayers.js -->
<script src="/javascripts/plugins/ol3/ol.js"></script>

<!-- LayerSwitcher JS -->
<script src="/javascripts/plugins/ol3-layerswitcher/src/ol3-layerswitcher.js"></script>

<!-- Estilos Features -->
<script src="/javascripts/openlayers/style.js"></script>

<!-- proyección -->
<script src="/javascripts/openlayers/proj.js"></script>

<!-- Capas -->
<script src="/javascripts/openlayers/capas.js"></script>	

<!-- Bootstrap Select JS -->
<script src="/javascripts/plugins/bootstrap-select/js/bootstrap-select.js"></script>

<!-- Mobile-Detect JS -->
<script src="//cdnjs.cloudflare.com/ajax/libs/mobile-detect/1.3.0/mobile-detect.min.js"></script>

<script type="text/javascript">

$('.selectpicker').selectpicker({
	width: '100%'
});

$("h1, h2").each(function(){
	var fontSize = $(this).css('font-size');
	console.log(fontSize);
	$(this).fitText(1.1, {maxFontSize: fontSize});
});

var helpTooltipElement, helpMsg;

function createHelpTooltip() {
    if (helpTooltipElement) {
      helpTooltipElement.parentNode.removeChild(helpTooltipElement);
    }
    helpTooltipElement = document.createElement('div');
    helpTooltipElement.className = 'tooltip hidden';
    helpTooltip = new ol.Overlay({
      element: helpTooltipElement,
      offset: [15, 0],
      positioning: 'center-left'
    });
    map.addOverlay(helpTooltip);
}

var pointerMoveHandler = function(evt) {
	  if (!hasbbox) {
	    return;
	  }
	  
	  $(helpTooltipElement).removeClass('hidden');
	  
	  if(evt.dragging){
		  helpTooltipElement.innerHTML = 'Suelta para acabar el BBOX';
		  helpTooltip.setPosition(evt.coordinate);
		  return;
	  }
	  
	  /** @type {string} */
	  var helpMsg = 'Click para empezar a dibujar BBOX';
	
	  helpTooltipElement.innerHTML = helpMsg;
	  helpTooltip.setPosition(evt.coordinate);
	
	  
};

//MousePosition Control --> ol.control.MousePosition
var mousePositionControl = new ol.control.MousePosition({
    coordinateFormat: ol.coordinate.toStringHDMS,
});

// Mapa --> ol.Map
var map = new ol.Map({
	controls: ol.control.defaults({ 
		attribution: false // No atribución
	}).extend([mousePositionControl, // MousePosition
	           new ol.control.FullScreen(), // FullScreen
	           new ol.control.LayerSwitcher({tipLabel: 'Leyenda'}), // LayerSwitcher
	           new ol.control.ScaleLine(), // ScaleLine
	           new ol.control.ZoomSlider() // ZoomSlider
	]),
	target: 'map',
	view: new ol.View({
		projection: proj,
		zoom: 3,
		center: ol.proj.fromLonLat([-0.47343, 39.42811], 'EPSG:4258'),
		minZoom: 0,
		maxZoom: 10
		// Importante poner nuestra proyección, aunque es un parámetro opcional HAY QUE PONERLO!
	})
});

map.addLayer(groupCapasBase); // Añadimos grupo de Capas 1
map.addLayer(groupCartoTorrentWMST); // Añadimos grupo de Capas 2
map.addLayer(groupCartoTorrentWMS); // Añadimos grupo de Capas 2


// Añadimos Control OverviewMap
map.addControl(new ol.control.OverviewMap({
	   layers: [new ol.layer.Tile(ignBase.getProperties())], 
	   view: new ol.View({ // Importante añadir la View con nuestra proyección
		   projection: proj  
	   })
}));

ignBase.setVisible(false);


var boundingBox;

boundingBox = new ol.interaction.DragBox({
    condition: ol.events.condition.always, // default
    className: 'line-dragbox'
});

map.addInteraction(boundingBox);

boundingBox.on('boxend', function(e){
	 $(helpTooltipElement).addClass('hidden');
	console.log('boxend');
	
	BootstrapDialog.show({
		type: BootstrapDialog.TYPE_INFO,
		title: 'DESCARGA DE CARTOGRAFÍA INTERACTIVA',
		message: '<p>¿Desea descargar la cartografía seleccionada?</p><p>Capa: ' + $('#capas_mapa').val() + '</p>' +
				 '<p> BBOX: [' + boundingBox.getGeometry().getExtent() + ']</p>',
		buttons: [{
		label: 'Cerrar',
		action: function(dialog){dialog.close();}},
		{label: 'SHP',
		action: function(dialog){
			dialog.close();
			window.open('http://localhost:8080/geoserver/jahr/ows?service=WFS&version=1.0.0' + 
			'&request=GetFeature&typeName=' + $('#capas_mapa').val() + '&outputFormat=shape-zip&bbox=' + boundingBox.getGeometry().getExtent());
		}},
		{label: 'GeoJSON',
		 action: function(dialog){
			 dialog.close();
			 window.open('http://localhost:8080/geoserver/jahr/ows?service=WFS&version=1.0.0' + 
			 '&request=GetFeature&typeName=' + $('#capas_mapa').val() + '&outputFormat=application/json&bbox=' + boundingBox.getGeometry().getExtent());
		 }},
		 {label: 'GML 3.2',
		  action: function(dialog){
			  dialog.close();
			  window.open('http://localhost:8080/geoserver/jahr/ows?service=WFS&version=1.0.0' + 
			  '&request=GetFeature&typeName=' + $('#capas_mapa').val() + '&outputFormat=application%2Fgml%2Bxml%3B+version%3D3.2&bbox=' + boundingBox.getGeometry().getExtent());
		  }}],
	});

});


map.on('pointermove', pointerMoveHandler);
createHelpTooltip();


// FIN MAPA
var hasbbox = true;

$('#mover').click(function(event){
	console.log('mover');
	map.removeInteraction(boundingBox);
	hasbbox = false;
	$(helpTooltipElement).addClass('hidden');
	
});

$('#bbox').click(function(event){
	console.log('bbox');
	if(!hasbbox){
		hasbbox = true;
		map.addInteraction(boundingBox);
		$(helpTooltipElement).removeClass('hidden');
	}
	
});


</script>

</body>
</html>