extends layout
block script
	link(rel='stylesheet', href='/stylesheets/profile-menu.css')
	script.
		$(function(){
			/**
			*********** XHR Eliminar
			**/
			
			$('.eliminar').click(function(e){
								
				var xhr = new XMLHttpRequest();  // XMLHttpRequest
	    
			    xhr.open('get', '/app/eliminar?id=' + $(this).attr('id'), true); // Método POSGT
			    
			    // Si hay algún error subiendo la imagen
			    xhr.onerror = function(e) {
			    	alert('Hubo un error eliminando la denuncia.');
			    };
			    
			    // Se elimina correctamente
			    var a = $(this);
			    xhr.onload = function() {			    	
			    	var msg = xhr.responseText; // Obtenemos la respuesta del servidor
					a.closest("tr").remove();
					
					$('#bodyTablaDenuncias tr td:first-child').each(function(index){
						//alert(index);
						$(this).html(index + 1);
					});
					
			    	BootstrapDialog.show({
						type: BootstrapDialog.INFO,
						title: 'Info',
						message: msg,
						closable: true,
						buttons: [{
							label: 'Cerrar',
							action: function(dialog){dialog.close()}
						}]
					});
			    	
			    };
			    // Enviamos la petición
			    xhr.send();
			    return false; // prevent default
			    
			});
			
			profileEdit = {};
		
			$('*[id*=oculto]').css('visibility','');
			$('*[id*=oculto]').slideUp(0);
			// Clicamos en el checkbox para editar
			$('input[type=checkbox]').bind('change', function(){
				if($(this).prop('checked'))
				{
					$('*[id*=change]').prop('disabled', false);
					$('*[id*=oculto]').stop(true, true).slideDown(500);
					//alert('enabled');
				}
				else
				{
					if(jQuery.isEmptyObject(profileEdit))
					{
						$('*[id*=change]').prop('disabled', true);
						$('*[id*=oculto]').stop(true, true).slideUp(500);
					}
					else
					{
						$(this).prop('checked', true);
						alert('Has cambiado propiedades de tu perfil');
					}
					//alert('disabled');
				}
			});
			// Editamos el perfil
			$('.form-control').bind('change', function(){
				var name = $(this).prop('name');
				profileEdit[name] = $(this).prop('value');
			});
			
			// Tabla mis denuncias
			    $('.filterable .btn-filter').click(function(){
			        var $panel = $(this).parents('.filterable'),
			        $filters = $panel.find('.filters input'),
			        $tbody = $panel.find('.table tbody');
			        if ($filters.prop('disabled') == true) {
			            $filters.prop('disabled', false);
			            $filters.first().focus();
			        } else {
			            $filters.val('').prop('disabled', true);
			            $tbody.find('.no-result').remove();
			            $tbody.find('tr').show();
			        }
			    });
			
			    $('.filterable .filters input').keyup(function(e){
			        /* Ignore tab key */
			        var code = e.keyCode || e.which;
			        if (code == '9') return;
			        /* Useful DOM data and selectors */
			        var $input = $(this),
			        inputContent = $input.val().toLowerCase(),
			        $panel = $input.parents('.filterable'),
			        column = $panel.find('.filters th').index($input.parents('th')),
			        $table = $panel.find('.table'),
			        $rows = $table.find('tbody tr');
			        /* Dirtiest filter function ever ;) */
			        var $filteredRows = $rows.filter(function(){
			            var value = $(this).find('td').eq(column).text().toLowerCase();
			            return value.indexOf(inputContent) === -1;
			        });
			        /* Clean previous no-result if exist */
			        $table.find('tbody .no-result').remove();
			        /* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
			        $rows.show();
			        $filteredRows.hide();
			        /* Prepend no-result row if all rows are filtered */
			        if ($filteredRows.length === $rows.length) {
			            $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="'+ $table.find('.filters th').length +'">No result found</td></tr>'));
			        }
			    });
		});
block content
	div#contenido(style={background: 'rgba(255,255,255,0)'})
		div.page-header
			h1(style={'font-size':'25px', color: '#00bbff'}) MI PERFIL
				small(style={'float':'right'}) 
					|  información de tu cuenta
		.portlet(style={background: 'rgba(200,50,0,0.4)', 'border-radius':'6px'})
			.portlet-title
				.caption.caption-red
					i.glyphicon.glyphicon-pushpin
					span.caption-subject.bold.font-yellow-crusta.uppercase #{user.profile.username || user.facebook.name || user.twitter.username}
					span.caption-helper   Hola de nuevo!
				ul.nav.nav-tabs
					li
						a(href='#portlet_tab3', data-toggle='tab') Cuentas Asociadas 
					li
						a(href='#portlet_tab2', data-toggle='tab') Mis denuncias
					li.active
						a(href='#portlet_tab1', data-toggle='tab') Perfil
			.portlet-body(style={'min-height':'600px'})
				.tab-content(style={'height':'100%'})
					#portlet_tab1.tab-pane.active
						.col-lg-4(style={'height':'300px'})
							img(src="#{user.profile.picture || user.facebook.photo || user.twitter.photo}" style={'width':'150px', 'margin-left':'25%'}).img-thumbnail
							hr
							div
								div.centrado Mis denuncias
								div.centrado Nueva denuncia
								div.centrado Cerrar Sesión
						.col-lg-8
							div(style={float:'right'}).well.checkbox.form-group.col-lg-12
								label
									input(type='checkbox') 
									| Editar Perfil
							.form-group.col-lg-6(style={'margin':'0 auto'})
								label.control-label(for='email') Email:
								input.form-control(name='email' value='#{user.local.email}', type='text', disabled)
								hr
							.form-group.col-lg-6(style={'margin':'0 auto'})
								label.control-label(for='usename') Nombre de usuario:
								input#change.form-control(name='username' value='#{user.profile.username}', type='text', disabled)
								hr
							.form-group.col-lg-6(style={'margin':'0 auto'})
								label.control-label(for='nombre') Nombre:
								input#change.form-control(name='nombre' value='#{user.profile.nombre}', type='text', disabled)
								hr
							.form-group.col-lg-6(style={'margin':'0 auto'})
								label.control-label(for='apellidos') Apellidos:
								input#change.form-control(name='apellidos' value='#{user.profile.apellidos}', type='text', disabled)
								hr
							.form-group.col-lg-6(style={'margin':'0 auto'})
								label.control-label(for='location') Localización preferida:
								input.form-control(name='location' value='#{JSON.stringify(user.profile.locationPref)}', type='text', disabled)
							#oculto.form-group.col-lg-6(style={'margin':'0 auto', visibility:'hidden'}) 
								div(style={width: '100%'} role='group').btn-group-vertical
									a(href="/app/changePass#scroll" target="_blank").btn.btn-default
										p(style={color: '#fff'}) Cambiar Contraseña
									button(type="button" class="btn btn-default")
										a(href="" target="_blank") 
											p(style={color: '#fff'}) Cambiar Localizacion
									button(type="button" class="btn btn-default")
										a(href="/" target="_blank") 
											p(style={color: '#ffbb00'}) Guardar
					
					#portlet_tab2.tab-pane 
						div.page-header
							h4 Mis denuncias
						br
						div(class="panel panel-primary filterable")
							div(class="panel-heading")
								h3(class="panel-title") Mis Denuncias
								div(class="pull-right")
									button(class="btn btn-default btn-xs btn-filter")
										span(class="glyphicon glyphicon-filter") 
										| Filtrar
							table#tablaDenuncias.table.table-condensed.table-hover
								thead
									tr(class="filters")
										th
											input(type="text" class="form-control" placeholder="#" disabled).text-center
										th
											input(type="text" class="form-control" placeholder="Título" disabled).text-center
										th
											input(type="text" class="form-control" placeholder="Fecha" disabled).text-center
										th
											input(type="text" class="form-control" placeholder="Comentarios" disabled).text-center
										th
											input(type="text" class="form-control" placeholder="Imágenes" disabled).text-center
										th.text-center Editar
										th.text-center Eliminar
								tbody#bodyTablaDenuncias
									- var i = 0;
									each denuncia in misDenuncias
										- i+=1
										tr(style={'word-break':'break-all'})
											td.text-center #{i}
											td.text-center
												a(href="/app/denuncia/#{denuncia.gid}" target="_blank") #{denuncia.titulo}
											td.text-center #{denuncia.fecha}
											if denuncia.comentarios
												td.text-center #{denuncia.comentarios.length}
											else
												td.text-center 0
											if denuncia.imagenes
												td.text-center #{denuncia.imagenes.length}
											else
												td.text-center 0
											td.text-center
												a(href="/app/editar?id=#{denuncia.gid}")
													i.fa.fa-edit(style={'font-size':'30px'})
											td.text-center
												a(href='#' id='#{denuncia.gid}' table-row=i).eliminar
													i.fa.fa-trash(style={'font-size':'30px'})						
					#portlet_tab3.tab-pane 
						div.page-header
							h4 Cuentas linqueadas
						
						div.col-lg-4(style={background:'#ffbb00', height:'300px', 'border-bottom-left-radius':'10px', 'border-top-left-radius':'10px'})
							div.page-header(style={'margin-top':'0px'})
								h4(style={color:'#fff'}) Cuenta local
							table.table.table-condensed.table-hover.centrado
								tbody
									tr
										td.blackb ID
										td.black 
											div.psus #{user._id}
									tr
										td.blackb EMAIL
										td.black 
											div.psus #{user.local.email}
									tr
										td.blackb USUARIO
										td.black 
											div.psus #{user.profile.username}												
						div.col-lg-4(style={background:'#3B5998', height:'300px'})
							div.page-header(style={'margin-top':'0px'})
								h4(style={color:'#fff'}) Facebook
							if (user.facebook && user.facebook.token)
								table.table.table-condensed.table-hover
									tbody
										tr
											td.blackb ID
											td.black 
												div.psus #{user.facebook.id}
										tr
											td.blackb TOKEN
											td.black 
												div.psus #{user.facebook.token}
										tr
											td.blackb EMAIL
											td.black 
												div.psus #{user.facebook.email}
										tr
											td.blackb NOMBRE
											td.black 
												div.psus #{user.facebook.name}

								a(href="/app/unlink/facebook" style={width:'100%'}).btn.btn-primary Deslinquear
							else
								a(href="/app/connect/facebook" style={width:'100%'}).btn.btn-primary Conectar con Facebook
							
						div.col-lg-4(style={background:'#00ACED', height:'300px', 'border-bottom-right-radius':'10px', 'border-top-right-radius':'10px'})
							div.page-header(style={'margin-top':'0px'})
								h4(style={color:'#fff'}) Twitter
							if (user.twitter && user.twitter.token)
								table.table.table-condensed.table-hover
									tbody
										tr
											td.blackb ID
											td.black 
												div.psus #{user.twitter.id}
										tr
											td.blackb TOKEN
											td.black 
												div.psus #{user.twitter.token}
										tr
											td.blackb NOMBRE USUARIO
											td.black 
												div.psus #{user.twitter.username}
										tr
											td.blackb NOMBRE
											td.black 
												div.psus #{user.twitter.displayName}
								a(href="/app/unlink/twitter" style={width:'100%'}).btn.btn-primary Deslinquear
							else
								a(href="/app/connect/twitter" style={width:'100%'}).btn.btn-primary Conectar con Twitter