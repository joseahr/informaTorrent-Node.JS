window.app = window.app || {};
var app = window.app;

/**
 * Control Creado para hacer peticiones GetFeatureInfo
 */
app.GetFeatureInfo = function(opt_options) {

  var options = opt_options || {};
  
  var hayInfo = false;
  
  var info = false;
  
  this.activar = function(bool){
	  console.log('activar feature info ', bool);
	  info = bool;
  }
  
  var popup = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
    element: document.getElementById('popup'),
    autoPan: true,
    autoPanAnimation: {
      duration: 250
    }
  }));
  
  map.addOverlay(popup);
  
  var helpTooltipElement, helpTooltip, helpMsg;

  function createHelpTooltip() {
      if (helpTooltipElement) {
        helpTooltipElement.parentNode.removeChild(helpTooltipElement);
      }
      helpTooltipElement = document.createElement('div');
      helpTooltipElement.className = 'tooltip hidden';
      helpTooltip = new ol.Overlay({
        element: helpTooltipElement,
        offset: [15, 0],
        positioning: 'center-left'
      });
      map.addOverlay(helpTooltip);
  }

  var pointerMoveHandler = function(evt) {
	  //console.log(JSON.stringify(helpTooltip), helpTooltipElement);
  	  if (evt.dragging || !info) {
  	    return;
  	  }
  	  /** @type {string} */
  	  helpMsg = '<i class="fa fa-info-circle"></i> Click para obtener información';
  	
  	  helpTooltipElement.innerHTML = helpMsg;
  	  helpTooltip.setPosition(evt.coordinate);
  	
  	  $(helpTooltipElement).removeClass('hidden');
  };
  
  var div;
  map.on('singleclick', function(evt){ // Cuando clickemos en el mapa 
    div = $(document.createElement('div'));
    if (!info) {$('.ol-popup').addClass('hidden'); return;}
    // Si el control está activado ...
    $('.ol-popup').removeClass('hidden');
    $('#popup-content').empty();
    div.css('overflow-x', 'scroll');
    var coordinate = evt.coordinate;
    div.append('<p>' + ol.coordinate.toStringHDMS(coordinate) + '</p>');
    groupCartoTorrentWMS.getLayers().forEach(function(layer, index, that){
      console.log(layer);
      var url;
      var append = '';
      if(layer.getSource() instanceof ol.source.TileWMS && layer.getVisible() == true){
        url = layer.getSource().getGetFeatureInfoUrl(
        	coordinate,
        	map.getView().getResolution(),
        	proj, 
        	{'INFO_FORMAT': 'text/html'}
        );
        $.get({url: url, async: false, success: function(data){
          data = JSON.parse(data);
          //if(!data) return;
          hayInfo = true;
          if(data) div.append($(data));
          //alert(JSON.stringify(div));
          $('table.featureInfo').addClass('table table-responsive auto');
          $('table.featureInfo tbody tr th').addClass('info auto');
	  console.log(index, that.length);

        }});
        if(index == that.length -1 && hayInfo) {
     		var button_mas_info = document.createElement('button');
	      	button_mas_info.className = 'btn btn-default';
	      	button_mas_info.innerHTML = 'VER INFORMACIÓN'
	      	button_mas_info.addEventListener('click', function(event){
		      BootstrapDialog.show({
			title: 'Operación GetFeatureInfo',
			message: div,
			buttons: [{
			  label: 'Cerrar',
			  action: function(dialog){dialog.close();}
			}]
		      });
	      	});
  
	      	$('#popup-content').append(button_mas_info);
	      	popup.setPosition(coordinate);
	      	hayInfo = false;
          }

      }
    });
  
  });
  
  $('#popup-closer').click(function() {
    popup.setPosition(undefined);
    $(this).blur();
    return false;
  });

  map.on('pointermove', pointerMoveHandler);
  createHelpTooltip();
  
  map.getViewport().addEventListener('mouseout', function(evt){
	    $(helpTooltipElement).addClass('hidden');
  }, false);

  var button = document.createElement('button');
  button.innerHTML = '<i class="fa fa-info-circle"></i>';

  var this_ = this;
  
  function getFeatureInfo_ (){
      $(helpTooltipElement).removeClass('hidden');
      info = true;
      console.log('get featue info activado');
  }
  button.addEventListener('click', getFeatureInfo_, false);

  var element = document.createElement('div');
  element.setAttribute('data-toggle', 'left');
  element.setAttribute('title', 'GetFeatureInfo');
  element.setAttribute('data-content', 'Obtener información de las entidades en un punto');
  element.className = 'get_feature_info ol-unselectable ol-control';
  element.appendChild(button);

  ol.control.Control.call(this, {
    element: element,
    target: options.target
  });

};
ol.inherits(app.GetFeatureInfo, ol.control.Control);
map.addControl(new app.GetFeatureInfo());
